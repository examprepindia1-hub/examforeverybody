{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    /* ... existing styles ... */
    .checkout-card { border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); overflow: hidden; }
    .product-img-container { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100%; min-height: 200px; }
    .product-img { max-height: 180px; object-fit: contain; }
    .price-tag { font-size: 2rem; font-weight: 700; color: #2c3e50; }
    .payment-option-card { border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
    .payment-option-card:hover { border-color: #dee2e6; }
    .payment-option-card.active { border-color: #198754; background-color: #f8fffb; }
    .timer-badge { font-family: monospace; font-size: 1.1rem; background: #e9ecef; padding: 5px 10px; border-radius: 5px; color: #495057; }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="mb-3">
                <a href="javascript:history.back()" class="text-decoration-none text-muted small"><i class="bi bi-arrow-left"></i> Back</a>
            </div>

            <div class="card checkout-card">
                <div class="row g-0">
                    <div class="col-md-5 bg-light border-end">
                        <div class="p-4 h-100 d-flex flex-column">
                            <h6 class="text-uppercase text-muted small fw-bold mb-3">Order Summary</h6>
                            <div class="product-img-container rounded mb-3">
                                {% if item.thumbnail_image %}
                                    <img src="{{ item.thumbnail_image.url }}" alt="{{ item.title }}" class="img-fluid product-img">
                                {% else %}
                                    <div class="text-muted">No Image</div>
                                {% endif %}
                            </div>
                            <h5 class="fw-bold text-dark">{{ item.title }}</h5>
                            <p class="text-muted small flex-grow-1">{{ item.description|truncatewords:15 }}</p>
                            <hr class="my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Total:</span>
                                <span class="price-tag text-success">₹{{ item.price }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7 bg-white">
                        <div class="p-4 p-md-5">
                            <h4 class="mb-1 fw-bold">Secure Checkout</h4>
                            <p class="text-muted small mb-4">Select your preferred payment method</p>

                            <div id="error-message" class="alert alert-danger d-none mb-4"></div>
                            <div id="success-message" class="alert alert-success d-none mb-4">Payment Successful! Redirecting...</div>

                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <div class="payment-option-card active" onclick="switchTab('paypal')" id="tab-paypal">
                                        <div class="fw-bold"><i class="bi bi-paypal me-2"></i>PayPal</div>
                                        <small class="text-muted">Cards / Int'l</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="payment-option-card" onclick="switchTab('upi')" id="tab-upi">
                                        <div class="fw-bold"><i class="bi bi-qr-code me-2"></i>UPI</div>
                                        <small class="text-muted">GPay / PhonePe</small>
                                    </div>
                                </div>
                            </div>

                            <div id="section-paypal">
                                <div id="paypal-button-container"></div>
                            </div>

                            <div id="section-upi" class="d-none">
                                
                                <div id="upi-step-1">
                                    <label class="form-label small text-muted">Enter the UPI ID you will pay from:</label>
                                    <input type="text" class="form-control mb-2" id="customer-vpa" placeholder="e.g. name@okhdfc">
                                    
                                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 py-2 px-3 mb-3">
                                        <div class="d-flex">
                                            <i class="bi bi-exclamation-triangle-fill text-warning me-2 mt-1"></i>
                                            <small class="text-dark" style="line-height: 1.3; font-size: 0.85rem;">
                                                <b>Important:</b> Verification will only work if you pay from the exact UPI ID entered above.
                                            </small>
                                        </div>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="upi-consent" onchange="toggleGenerateBtn()">
                                        <label class="form-check-label small text-muted user-select-none" for="upi-consent">
                                            I confirm I will pay from this UPI ID.
                                        </label>
                                    </div>

                                    <button class="btn btn-success w-100 py-2" type="button" id="btn-generate-qr" onclick="generateQR()" disabled>
                                        <i class="bi bi-qr-code-scan me-1"></i> Generate Payment QR
                                    </button>
                                </div>

                                <div id="upi-step-2" class="d-none text-center">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold text-success mb-0">Scan to Pay</h6>
                                        <span id="timer-display" class="timer-badge">04:00</span>
                                    </div>
                                    
                                    <div class="position-relative d-inline-block">
                                        <div class="p-3 border rounded bg-white mb-3">
                                            <img id="qr-image" src="" alt="UPI QR" class="img-fluid" style="max-width: 200px;">
                                        </div>

                                        <div id="qr-timeout-overlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white d-none flex-column justify-content-center align-items-center p-3 text-center" style="z-index: 10;">
                                            <i class="bi bi-info-circle-fill text-warning fs-1 mb-2"></i>
                                            <h6 class="fw-bold text-dark">Payment Timed Out</h6>
                                            <p class="small text-muted mb-3" style="font-size: 0.8rem; line-height: 1.4;">
                                                Don't worry! If money was deducted, it is safe. <br>
                                                Please contact support with Order Ref: <br>
                                                <strong class="text-dark" id="timeout-ref"></strong>
                                            </p>
                            
                                        </div>
                                    </div>

                                    <p class="small text-muted mb-1">Total Amount: <strong class="text-dark">₹{{ item.price }}</strong></p>
                                    <p class="small text-muted">Ref: <span id="order-ref"></span></p>
                                    
                                    <div id="poll-status-msg" class="alert alert-info small mt-3 border-0 bg-info bg-opacity-10 text-info-emphasis">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Waiting for payment confirmation...
                                    </div>

                                    <div id="delay-warning" class="alert alert-warning small mt-3 border-0 bg-warning bg-opacity-10 d-none">
                                        <i class="bi bi-hourglass-split me-2"></i>
                                        Payment is taking longer than usual. Please stay on this page, do not refresh.
                                    </div>
                                </div>
                            </div>

                            <div id="loading-message" class="text-center py-4 d-none">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="small text-muted mt-2">Generating secure QR...</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency={{ paypal_currency }}"></script>
<script>
    const csrftoken = "{{ csrf_token }}";
    let pollInterval = null;
    let countdownInterval = null;
    let timeLeft = 240; // 4 minutes

    function toggleGenerateBtn() {
        const isChecked = document.getElementById('upi-consent').checked;
        const btn = document.getElementById('btn-generate-qr');
        if (isChecked) btn.removeAttribute('disabled');
        else btn.setAttribute('disabled', 'true');
    }

    function switchTab(method) {
        document.querySelectorAll('.payment-option-card').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${method}`).classList.add('active');

        if(method === 'paypal') {
            document.getElementById('section-paypal').classList.remove('d-none');
            document.getElementById('section-upi').classList.add('d-none');
            stopPolling();
        } else {
            document.getElementById('section-paypal').classList.add('d-none');
            document.getElementById('section-upi').classList.remove('d-none');
        }
    }

    function generateQR() {
        const vpaInput = document.getElementById('customer-vpa');
        const vpa = vpaInput.value.trim();
        const checkbox = document.getElementById('upi-consent');
        
        if(!vpa) { showError("Please enter your UPI ID."); return; }
        if(!checkbox.checked) { showError("Please confirm consent."); return; }

        const upiRegex = /^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/;
        if (!upiRegex.test(vpa)) {
            showError("Invalid UPI format. Example: name@okhdfc");
            vpaInput.classList.add('is-invalid');
            return;
        }
        
        vpaInput.classList.remove('is-invalid');
        document.getElementById('error-message').classList.add('d-none');
        document.getElementById('upi-step-1').classList.add('d-none');
        document.getElementById('loading-message').classList.remove('d-none');

        fetch("{% url 'create_upi_order' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
            body: JSON.stringify({ slug: "{{ item.slug }}", upi_id: vpa })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading-message').classList.add('d-none');
            if(data.error) {
                showError(data.error);
                document.getElementById('upi-step-1').classList.remove('d-none');
            } else {
                document.getElementById('qr-image').src = data.qr_url;
                document.getElementById('order-ref').textContent = data.order_ref;
                document.getElementById('timeout-ref').textContent = data.order_ref; // Set for timeout screen
                document.getElementById('upi-step-2').classList.remove('d-none');
                startPolling(data.order_ref);
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('loading-message').classList.add('d-none');
            document.getElementById('upi-step-1').classList.remove('d-none');
            showError("Connection error.");
        });
    }

    function startPolling(orderId) {
        timeLeft = 180; 
        updateTimerDisplay();
        document.getElementById('delay-warning').classList.add('d-none'); // Reset warning
        
        countdownInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();

            // SHOW WARNING if time is running low (e.g., less than 1 min left)
            if (timeLeft === 60) {
                document.getElementById('delay-warning').classList.remove('d-none');
            }

            if (timeLeft <= 0) {
                handleTimeout(orderId);
            }
        }, 1000);

        pollInterval = setInterval(() => {
            checkStatus(orderId);
        }, 3000);
    }

    function checkStatus(orderId) {
        fetch(`/billing/api/check-status/${orderId}/`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'PAID') {
                stopPolling();
                document.getElementById('success-message').classList.remove('d-none');
                window.location.href = "{% url 'marketplace:item_detail' slug=item.slug %}";
            } else if (data.status === 'FAILED') {
                stopPolling();
                showError("Payment Failed or Declined.");
            }
        });
    }

    function handleTimeout(orderId) {
        stopPolling();
        fetch(`/billing/api/expire-order/${orderId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken }
        })
        .then(() => {
            // Hide Status Messages
            document.getElementById('poll-status-msg').classList.add('d-none');
            document.getElementById('delay-warning').classList.add('d-none');
            
            // Show "Rest Assured" Overlay
            document.getElementById('qr-timeout-overlay').classList.remove('d-none');
            document.getElementById('qr-timeout-overlay').classList.add('d-flex');
        });
    }

    function stopPolling() {
        if (pollInterval) clearInterval(pollInterval);
        if (countdownInterval) clearInterval(countdownInterval);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer-display').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function showError(msg) {
        const errDiv = document.getElementById('error-message');
        errDiv.textContent = msg;
        errDiv.classList.remove('d-none');
    }

    // PayPal Init
    if(window.paypal) {
        paypal.Buttons({
            style: { shape: 'rect', color: 'gold', layout: 'vertical', label: 'pay' },
            createOrder: function(data, actions) {
                return fetch("{% url 'create_paypal_order' %}", {
                    method: "post",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
                    body: JSON.stringify({ slug: "{{ item.slug }}" })
                }).then(res => res.json()).then(order => order.id);
            },
            onApprove: function(data, actions) {
                return fetch("{% url 'capture_paypal_order' %}", {
                    method: "post",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
                    body: JSON.stringify({ orderID: data.orderID })
                }).then(res => res.json()).then(data => {
                    if (data.status === 'COMPLETED') window.location.href = "{% url 'marketplace:item_detail' slug=item.slug %}";
                });
            }
        }).render('#paypal-button-container');
    }
</script>
{% endblock %}