<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam in Progress - {{ test.item.title }}</title>
    {% load static %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <script>
        window.MathJax = {
            tex: { inlineMath: [['\\(', '\\)'], ['$', '$']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Desmos Graphing Calculator Integration -->
    <script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=8f3af243824042a7a8a697f730059d9e"></script>
    <style>
        #desmos-calculator-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(44, 62, 80, 0.85);
            align-items: center;
            justify-content: center;
        }

        #desmos-calculator-box {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            padding: 0;
            width: 640px;
            max-width: 98vw;
            position: relative;
        }

        #desmos-calculator-header {
            background: #222f3e;
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #desmos-calculator-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        #calculator {
            width: 600px;
            height: 400px;
            margin: 0 auto;
        }

        @media (max-width: 700px) {
            #calculator {
                width: 95vw;
                height: 60vw;
                min-height: 300px;
            }

            #desmos-calculator-box {
                width: 98vw;
            }
        }
    </style>

    <style>
        .beat-animation {
            animation: beat 1s infinite;
        }

        @keyframes beat {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        body {
            background-color: #f4f6f8;
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }

        /* --- Header --- */
        .exam-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            z-index: 20;
            position: relative;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            color: #6c757d;
            border-right: 1px solid #dee2e6;
            padding-right: 15px;
            margin-right: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timer-box {
            background: #fff;
            color: #dc3545;
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: 700;
            font-family: monospace;
            font-size: 1.3rem;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Layout --- */
        .exam-container {
            height: calc(100vh - 60px);
            display: flex;
        }

        .question-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .question-scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            scroll-behavior: smooth;
            background-color: #f4f6f8;
            padding-bottom: 100px;
        }

        .question-block {
            display: none;
        }

        .question-block.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Enhanced Card */
        .question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid #eaeaea;
        }

        .question-text {
            font-size: 1.15rem;
            color: #212529;
            line-height: 1.6;
            font-weight: 500;
        }

        /* Split Screen */
        .passage-col {
            border-right: 1px solid #dee2e6;
            padding-right: 25px;
            max-height: 65vh;
            overflow-y: auto;
        }

        .question-col {
            padding-left: 25px;
        }

        @media(max-width: 991px) {
            .passage-col {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 20px;
                margin-bottom: 20px;
                padding-right: 0;
                padding-left: 0;
                max-height: 400px;
            }

            .question-col {
                padding-left: 0;
            }
        }

        .nav-footer {
            height: 70px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
            z-index: 5;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 340px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .accordion-button {
            padding: 12px 15px;
            font-size: 0.9rem;
            font-weight: 600;
            background-color: #f8f9fa;
            color: #495057;
        }

        .accordion-button:not(.collapsed) {
            color: #0056D2;
            background-color: #eef2ff;
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
        }

        .accordion-body {
            padding: 10px;
            background: #fff;
        }

        .palette-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .palette-btn {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            color: #495057;
        }

        .palette-btn:hover {
            background-color: #e9ecef;
        }

        .palette-btn.current {
            border-color: #0056D2;
            box-shadow: 0 0 0 2px #0056D2;
            z-index: 2;
            transform: scale(1.05);
        }

        .palette-btn.answered {
            background-color: #198754;
            color: white;
            border-color: #198754;
        }

        .palette-btn.review {
            background-color: #6610f2;
            color: white;
            border-color: #6610f2;
        }

        .palette-btn.review-answered {
            background-color: #6610f2;
            color: white;
            border-color: #6610f2;
            position: relative;
        }

        .palette-btn.review-answered::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #0dcaf0;
            border-radius: 50%;
            border: 1px solid #6610f2;
        }

        #fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stat-box {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid;
        }

        /* Options Styling */
        .option-wrapper {
            cursor: pointer;
            transition: 0.2s;
        }

        .option-wrapper:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd !important;
        }

        .answer-input:checked+label {
            font-weight: 600;
            color: #0d6efd;
        }
    </style>

    <!-- CRITICAL: Mobile CSS Overrides -->
    <style>
        @media (max-width: 991px) {
            body {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                height: auto !important;
            }

            .exam-container {
                height: auto !important;
                min-height: calc(100vh - 60px) !important;
                display: block !important;
            }

            .question-area {
                height: auto !important;
                width: 100% !important;
            }

            .question-scroll-content {
                height: auto !important;
                overflow-y: visible !important;
                padding: 20px 14px 140px 14px !important;
            }

            /* Hide sidebar by default on mobile */
            .sidebar {
                position: fixed !important;
                right: -100vw !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                background: white !important;
                transition: right 0.35s ease !important;
                top: 0 !important;
            }

            .sidebar.show {
                right: 0 !important;
            }

            /* Fixed nav footer */
            .nav-footer {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                background: white !important;
                border-top: 2px solid #dee2e6 !important;
                height: 110px !important;
                padding: 0 !important;
                z-index: 999 !important;
                box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1) !important;
                display: block !important;
            }

            .nav-footer>div:first-child {
                display: contents !important;
            }

            #btn-prev {
                position: absolute !important;
                top: 10px !important;
                left: 10px !important;
                width: calc(50% - 15px) !important;
                height: 40px !important;
                margin: 0 !important;
            }

            #btn-next {
                position: absolute !important;
                top: 10px !important;
                right: 10px !important;
                width: calc(50% - 15px) !important;
                height: 40px !important;
                margin: 0 !important;
            }

            .nav-footer button.btn-outline-danger {
                position: absolute !important;
                bottom: 10px !important;
                left: 10px !important;
                width: calc(50% - 15px) !important;
                height: 40px !important;
                margin: 0 !important;
                font-size: 0.9rem !important;
            }

            .nav-footer .form-check {
                position: absolute !important;
                bottom: 10px !important;
                right: 10px !important;
                width: calc(50% - 15px) !important;
                height: 40px !important;
                background: #f8f9fa !important;
                border-radius: 6px !important;
                border: 1px solid #dee2e6 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 !important;
                padding: 0 5px !important;
            }

            .form-check-label {
                font-size: 0.8rem !important;
                margin-left: 6px !important;
            }

            /* Bigger touch targets */
            .option-wrapper {
                padding: 18px 16px !important;
                min-height: 64px !important;
                border: 2px solid #e0e0e0 !important;
            }

            .answer-input {
                width: 24px !important;
                height: 24px !important;
            }

            /* Show toggle button */
            .sidebar-toggle-btn {
                display: flex !important;
            }

            /* Header optimizations */
            .exam-header .btn span {
                display: none !important;
            }

            .exam-header .btn i {
                margin: 0 !important;
                font-size: 1.2rem !important;
            }
        }

        .sidebar-toggle-btn {
            display: none;
            position: fixed;
            bottom: 130px;
            right: 20px;
            z-index: 1030;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }
    </style>
</head>

<body oncontextmenu="return false;">

    <div id="global-loader" class="d-none"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="mt-3 fw-bold text-dark">Submitting Assessment...</h5>
        <p class="text-muted small">Please do not close this window.</p>
    </div>

    <div id="fullscreen-overlay">
        <div class="text-center px-4">
            <div class="spinner-grow text-primary mb-4" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h2 class="fw-bold mb-3 fs-4 fs-md-2">Exam Environment Ready</h2>
            <p class="text-muted mb-4 small px-2">Click below to enter full-screen mode and start the timer.</p>
            <button class="btn btn-primary btn-lg rounded-pill px-4 px-md-5 shadow" onclick="enableFullScreen()">
                <i class="bi bi-arrows-fullscreen me-2"></i> Begin Assessment
            </button>
        </div>
    </div>

    <div class="exam-header">
        <div class="d-flex align-items-center">
            <span class="h5 mb-0 fw-bold text-primary me-3">e4e</span>
            <div style="height: 25px; width: 1px; background: #e0e0e0; margin-right: 15px;"></div>
            <h6 class="mb-0 text-secondary d-none d-md-block text-truncate" style="max-width: 300px;">
                {{ test.item.title }}</h6>
        </div>

        <div class="d-flex align-items-center gap-3">
            <div class="system-status d-none d-lg-flex">
                <div class="status-item" title="Current Time"><span id="system-time">--:--</span></div>
                <div class="status-item" id="battery-status" title="Battery"><i class="bi bi-battery-full"
                        id="battery-icon"></i><span id="battery-level">--%</span></div>
            </div>
            <button class="btn btn-light border btn-sm fw-bold text-dark" onclick="toggleDesmosCalculator()">
                <i class="bi bi-calculator"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm border-0" data-bs-toggle="modal"
                data-bs-target="#instructionsModal"><i class="bi bi-info-circle me-1"></i> Instructions</button>
            <div class="timer-box" id="timer"><i class="bi bi-stopwatch"></i> <span>00:00:00</span></div>
            <button type="button" class="btn btn-dark btn-sm fw-bold px-3" onclick="confirmSubmit()">Finish</button>
            <form id="submit-form" action="{% url 'submit_test' attempt.id %}" method="post" style="display:none;">
                {% csrf_token %}
            </form>
        </div>
    </div>

    <!-- Mobile Sidebar Toggle Button -->
    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()"
        aria-label="Toggle Question Palette">
        <i class="bi bi-grid-3x3-gap-fill"></i>
    </button>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="exam-container">
        <div class="question-area">
            <div class="question-scroll-content" id="question-container">
                {% for section in sections %}
                {% for question in section.questions.all %}
                <div class="question-block" id="q-block-{{ question.id }}" data-section-id="{{ section.id }}"
                    data-qid="{{ question.id }}">

                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <span class="badge bg-light text-secondary border text-uppercase ls-1">
                            {{ section.title }}</span>
                    </div>

                    <div class="question-card">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <span
                                class="badge bg-primary bg-opacity-10 text-primary border border-primary-subtle px-3 py-2 rounded-pill">
                                Q{{ forloop.counter }}.
                            </span>
                            <div class="d-flex gap-3 align-items-center">
                                <span class="badge bg-warning text-dark border d-none word-count-badge"
                                    id="wc-{{ question.id }}">0 Words</span>
                                <button type="button" class="btn btn-link text-muted p-0"
                                    onclick="reportQuestion('{{ question.id }}')" title="Report Issue">
                                    <i class="bi bi-flag"></i>
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            {% if question.passage %}
                            <div class="col-lg-6 passage-col">
                                <div class="bg-light p-4 rounded-3 text-secondary"
                                    style="font-family: 'Georgia', serif; line-height: 1.8;">
                                    <div class="small fw-bold text-uppercase text-muted mb-3 pb-2 border-bottom">Read
                                        the Passage</div>
                                    {{ question.passage.content|safe|linebreaks }}
                                    {% if question.passage.image %}
                                    <img src="{{ question.passage.image.url }}"
                                        class="img-fluid mt-3 rounded shadow-sm">
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="{% if question.passage %}col-lg-6 question-col{% else %}col-12{% endif %}">
                                {% if question.audios.all %}
                                <div class="mb-4 p-3 bg-warning bg-opacity-10 border border-warning rounded-3">
                                    <h6 class="fw-bold small text-uppercase mb-2 text-warning-emphasis"><i
                                            class="bi bi-headphones me-2"></i>Audio Clip</h6>
                                    {% for audio in question.audios.all %}
                                    <audio controls controlsList="nodownload" class="w-100">
                                        <source src="{{ audio.audio_file.url }}" type="audio/mpeg">
                                    </audio>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <div class="question-text mb-4">
                                    {{ question.question_text|safe|linebreaks }}
                                    {% for media in question.images.all %}
                                    <img src="{{ media.image.url }}"
                                        class="img-fluid rounded border my-2 d-block mx-auto"
                                        style="max-height: 300px;">
                                    {% if media.caption %}
                                    <div class="text-center small text-muted fst-italic">
                                        {{ media.caption }}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>

                                <div class="options-list">
                                    {% if question.question_type == 'MCQ' %}
                                    {% for option in question.options.all %}
                                    <div
                                        class="form-check mb-3 p-3 border rounded-3 bg-white d-flex align-items-start option-wrapper">
                                        <input class="form-check-input answer-input me-3 mt-1 flex-shrink-0"
                                            type="radio" name="question_{{ question.id }}" id="opt_{{ option.id }}"
                                            value="{{ option.id }}" data-qid="{{ question.id }}"
                                            style="transform: scale(1.3);">
                                        <label class="form-check-label w-100 cursor-pointer" for="opt_{{ option.id }}"
                                            style="line-height: 1.5;">
                                            {% if option.option_image %}
                                            <img src="{{ option.option_image.url }}"
                                                class="img-fluid rounded border mb-2 d-block"
                                                style="max-height: 120px;">
                                            {% endif %}
                                            {{ option.option_text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                    {% elif question.question_type == 'ESSAY' or question.question_type == 'NUMERIC' %}
                                    <div class="form-group">
                                        <textarea
                                            class="form-control p-3 border-secondary-subtle shadow-sm answer-text-input"
                                            style="resize: vertical;"
                                            rows="{% if question.question_type == 'ESSAY' %}12{% else %}2{% endif %}"
                                            data-qid="{{ question.id }}" data-type="{{ question.question_type }}"
                                            placeholder="Type your answer here..."></textarea>
                                        {% if question.question_type == 'ESSAY' %}
                                        <div class="form-text text-end small">Word count updates automatically.</div>
                                        {% endif %}
                                    </div>
                                    {% elif question.question_type == 'SPEAKING' %}
                                    <div class="audio-recorder-box text-center p-4 border rounded-3 bg-light">
                                        <div class="mb-3"><i class="bi bi-mic-fill text-danger fs-1"
                                                id="mic-icon-{{ question.id }}"></i></div>
                                        <h6 class="mb-3" id="status-{{ question.id }}">Click record to start answering
                                        </h6>
                                        <button class="btn btn-danger rounded-pill px-4 me-2"
                                            id="btn-record-{{ question.id }}"
                                            onclick="startRecording({{ question.id }})"><i
                                                class="bi bi-record-circle"></i> Record</button>
                                        <button class="btn btn-dark rounded-pill px-4" id="btn-stop-{{ question.id }}"
                                            onclick="stopRecording({{ question.id }})" disabled><i
                                                class="bi bi-stop-fill"></i> Stop</button>
                                        <div class="mt-3 d-none" id="playback-container-{{ question.id }}">
                                            <audio controls class="w-100 mb-2"
                                                id="audio-preview-{{ question.id }}"></audio>
                                            <div class="text-success small fw-bold"><i
                                                    class="bi bi-check-circle-fill"></i> Answer Saved Successfully</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <input type="checkbox" id="review_{{ question.id }}" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endfor %}
            </div>

            <div class="nav-footer">
                <div>
                    <button class="btn btn-outline-secondary me-2" id="btn-prev" onclick="navigate(-1)"><i
                            class="bi bi-chevron-left"></i> Previous</button>
                    <button class="btn btn-outline-danger" onclick="clearCurrentResponse()">Clear Answer</button>
                </div>
                <div class="form-check form-switch ms-3">
                    <input class="form-check-input" type="checkbox" id="current-review-chk"
                        style="transform: scale(1.2);">
                    <label class="form-check-label small fw-bold ms-2" for="current-review-chk">Mark for Review</label>
                </div>
                <button class="btn btn-primary px-4" id="btn-next" onclick="navigate(1)">Next <i
                        class="bi bi-chevron-right"></i></button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <!-- Mobile Sidebar Header with Close Button -->
            <div
                class="d-lg-none d-flex justify-content-between align-items-center p-3 border-bottom bg-primary text-white">
                <h6 class="mb-0 fw-bold"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Question Palette</h6>
                <button type="button" class="btn btn-light btn-sm" onclick="closeSidebar()">
                    <i class="bi bi-x-lg"></i> Close
                </button>
            </div>
            <div class="accordion accordion-flush flex-grow-1 overflow-y-auto custom-scrollbar" id="paletteAccordion">
                {% for section in sections %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#section-collapse-{{ section.id }}">
                            {{ section.title }}
                        </button>
                    </h2>
                    <div id="section-collapse-{{ section.id }}"
                        class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                        data-bs-parent="#paletteAccordion">
                        <div class="accordion-body">
                            <div class="palette-grid">
                                {% for question in section.questions.all %}
                                <div class="palette-btn" id="palette-btn-{{ question.id }}"
                                    onclick="jumpToQuestion('{{ question.id }}')">{{ forloop.counter }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="p-3 bg-light border-top small">
                <div class="row g-2">
                    <div class="col-6"><span class="badge bg-success rounded-circle p-1 me-1"> </span> Answered</div>
                    <div class="col-6"><span class="badge bg-secondary rounded-circle p-1 me-1"> </span> Not Visited
                    </div>
                    <div class="col-6"><span class="badge bg-primary rounded-circle p-1 me-1"> </span> Active</div>
                    <div class="col-6"><span class="badge rounded-circle p-1 me-1" style="background:#6610f2;"> </span>
                        Review</div>
                </div>
            </div>

            <!-- Mobile Finish Button -->
            <div class="d-lg-none p-3 border-top">
                <button type="button" class="btn btn-danger w-100 fw-bold py-2" onclick="confirmSubmit()">
                    <i class="bi bi-check-circle-fill me-2"></i>Finish Test
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="submitSummaryModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">Exam Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <p class="text-muted mb-4">You are about to submit your test. Here is your status:</p>
                    <div class="row g-3 text-center mb-4">
                        <div class="col-4">
                            <div class="stat-box bg-success bg-opacity-10 border-success">
                                <h2 class="fw-bold text-success mb-0" id="summary-answered">0</h2><small
                                    class="text-success fw-bold">Answered</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box"
                                style="background-color: #f3ebff; border-color: #d0bfff; color: #6610f2;">
                                <h2 class="fw-bold mb-0" id="summary-review">0</h2><small class="fw-bold">Review</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-box bg-danger bg-opacity-10 border-danger">
                                <h2 class="fw-bold text-danger mb-0" id="summary-unanswered">0</h2><small
                                    class="text-danger fw-bold">Skipped</small>
                            </div>
                        </div>
                    </div>
                    <div id="review-warning" class="alert alert-warning small d-none"><i
                            class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Warning:</strong> You have
                        questions marked for review.</div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">Keep Working</button>
                    <button type="button" class="btn btn-dark rounded-pill px-4 fw-bold" onclick="finalSubmit()">Submit
                        Exam</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="timeWarningModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning border-3 shadow-lg">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h3 class="fw-bold text-dark">2 Minutes Remaining!</h3>
                    <p class="text-muted">Please review your answers. The exam will auto-submit when the timer reaches
                        zero.</p>
                    <button type="button" class="btn btn-warning rounded-pill px-5 fw-bold text-dark mt-2"
                        data-bs-dismiss="modal">
                        Okay, Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="instructionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Exam Instructions</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-muted">{{ test.instructions|safe|linebreaks }}</div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Resume
                        Test</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Question</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="report-qid">
                    <div class="mb-3">
                        <label class="form-label">Issue Description</label>
                        <textarea class="form-control" id="report-reason" rows="3"
                            placeholder="e.g. Typo, wrong answer..."></textarea>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-danger"
                        onclick="submitReport()">Submit</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportSuccessModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg text-center p-4">
                <div class="mb-3">
                    <div class="spinner-grow text-success" role="status"
                        style="width: 1rem; height: 1rem; animation-duration: 2s;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <i class="bi bi-check-circle-fill text-success position-absolute"
                        style="font-size: 3rem; transform: translate(-50%, -50%); margin-left: -0.5rem; margin-top: 0.5rem;"></i>
                </div>
                <div class="mt-4">
                    <h4 class="fw-bold text-dark">Thank You</h4>
                    <p class="text-muted">Your report has been submitted successfully.<br>Our team will review the
                        issue.</p>
                    <button type="button" class="btn btn-primary rounded-pill px-5 py-2 shadow-sm fw-bold"
                        onclick="resumeAfterReport()">
                        <i class="bi bi-arrows-fullscreen me-2"></i> Resume Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="exam-calculator" class="card shadow border-0"
        style="position: fixed; bottom: 20px; right: 20px; width: 260px; z-index: 1000; display: none; background: #2c3e50;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2"
            style="cursor: move;" id="calc-header">
            <small><i class="bi bi-calculator me-2"></i>Calculator</small>
            <button type="button" class="btn-close btn-close-white small" onclick="toggleCalculator()"></button>
        </div>
        <div class="p-2">
            <input type="text" id="calc-display" class="form-control text-end mb-2 fs-4 fw-bold bg-light" readonly
                value="0">
            <div class="row g-1">
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('(')">(</button>
                </div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput(')')">)</button>
                </div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('%')">%</button>
                </div>
                <div class="col-3"><button class="btn btn-warning w-100 btn-sm" onclick="calcClear()">AC</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('7')">7</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('8')">8</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('9')">9</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('/')">รท</button>
                </div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('4')">4</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('5')">5</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('6')">6</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('*')">ร</button>
                </div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('1')">1</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('2')">2</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('3')">3</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('-')">-</button>
                </div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('0')">0</button></div>
                <div class="col-3"><button class="btn btn-light w-100 btn-sm" onclick="calcInput('.')">.</button></div>
                <div class="col-3"><button class="btn btn-primary w-100 btn-sm" onclick="calcSolve()">=</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="calcInput('+')">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Desmos Calculator Modal -->
    <div id="desmos-calculator-modal">
        <div id="desmos-calculator-box">
            <div id="desmos-calculator-header">
                <span><i class="bi bi-calculator me-2"></i></span>
                <button id="desmos-calculator-close" onclick="toggleDesmosCalculator()">&times;</button>
            </div>
            <div id="calculator"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // 1. LOADER & CORE UTILITIES
        // ==========================================
        const loader = document.getElementById('global-loader');
        let activeRequests = 0;

        window.showLoader = function () {
            activeRequests++;
            if (loader) loader.classList.remove('d-none');
        };

        window.hideLoader = function (force = false) {
            if (force) activeRequests = 0;
            else activeRequests--;

            if (activeRequests <= 0) {
                activeRequests = 0;
                if (loader) loader.classList.add('d-none');
            }
        };

        // Fetch Interceptor to handle global loading state automatically
        const originalFetch = window.fetch;
        window.fetch = function (input, init) {
            // Check for 'skipLoader' flag to avoid flashing spinner on auto-saves
            if (init && init.skipLoader) {
                return originalFetch.apply(this, arguments);
            }
            showLoader();
            return originalFetch.apply(this, arguments).finally(() => {
                hideLoader();
            });
        };

        // Page Navigation Loader
        document.addEventListener('click', function (e) {
            const link = e.target.closest('a');
            if (link && link.href && !link.target && !link.hasAttribute('download') &&
                !e.ctrlKey && !e.metaKey && !link.href.includes('#') && link.hostname === window.location.hostname) {
                activeRequests = 0;
                showLoader();
            }
        });

        // ==========================================
        // 2. EXAM LOGIC
        // ==========================================
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const savedAnswers = {{ answers_json| safe }};
        const allQuestionIds = [];
        {% for section in sections %}
        {% for q in section.questions.all %}
        allQuestionIds.push("{{ q.id }}");
        {% endfor %}
        {% endfor %}

        let currentIdx = 0;
        let isFullScreen = false;
        let submitModal = null;
        let reportModal = null;
        let mediaRecorder;
        let audioChunks = [];

        // --- CALCULATOR LOGIC ---
        function toggleCalculator() {
            const calc = document.getElementById('exam-calculator');
            calc.style.display = (calc.style.display === 'none') ? 'block' : 'none';
        }
        function calcInput(val) {
            const display = document.getElementById('calc-display');
            if (display.value === '0') display.value = val; else display.value += val;
        }
        function calcClear() { document.getElementById('calc-display').value = '0'; }
        function calcSolve() {
            try { document.getElementById('calc-display').value = eval(document.getElementById('calc-display').value); }
            catch { document.getElementById('calc-display').value = 'Error'; }
        }

        // --- AUDIO RECORDING ---
        function startRecording(qid) {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                // UI Updates
                document.getElementById(`mic-icon-${qid}`).classList.add('beat-animation');
                document.getElementById(`status-${qid}`).innerText = "Recording... Speak now.";
                document.getElementById(`btn-record-${qid}`).disabled = true;
                document.getElementById(`btn-stop-${qid}`).disabled = false;

                mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    uploadAudio(qid, audioBlob);
                });
            });
        }

        function stopRecording(qid) {
            if (mediaRecorder) {
                mediaRecorder.stop();
                document.getElementById(`mic-icon-${qid}`).classList.remove('beat-animation');
                document.getElementById(`status-${qid}`).innerText = "Processing...";
                document.getElementById(`btn-record-${qid}`).disabled = false;
                document.getElementById(`btn-stop-${qid}`).disabled = true;
            }
        }

        function uploadAudio(qid, blob) {
            const formData = new FormData();
            formData.append('attempt_id', {{ attempt.id }});
        formData.append('question_id', qid);
        formData.append('audio_data', blob, `answer_${qid}.wav`);

        // Use skipLoader: true to avoid full screen spinner
        fetch("{% url 'save_answer' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData,
            skipLoader: true
        })
            .then(res => res.json())
            .then(data => {
                const audioUrl = URL.createObjectURL(blob);
                const audioEl = document.getElementById(`audio-preview-${qid}`);
                audioEl.src = audioUrl;
                document.getElementById(`playback-container-${qid}`).classList.remove('d-none');
                document.getElementById(`status-${qid}`).innerText = "Recording saved.";
                updatePaletteVisuals(qid, true, false);
            })
            .catch(err => {
                console.error("Upload failed", err);
                alert("Failed to save audio. Please try again.");
            });
        }

        // --- ANSWER SAVING ---
        function saveData(qid) {
            const selectedRadio = document.querySelector(`input[name="question_${qid}"]:checked`);
            const textInput = document.querySelector(`textarea[data-qid="${qid}"]`);

            const optionId = selectedRadio ? selectedRadio.value : null;
            const textVal = textInput ? textInput.value : null;
            const isReviewed = document.getElementById(`review_${qid}`).checked;

            const isAnswered = !!optionId || (textVal && textVal.trim().length > 0);
            updatePaletteVisuals(qid, isAnswered, isReviewed);

            // Use skipLoader: true to avoid interrupting user flow
            fetch("{% url 'save_answer' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify({
                    attempt_id: {{ attempt.id }},
                question_id: qid,
                option_id: optionId,
                text_input: textVal,
                is_reviewed: isReviewed
                }),
        skipLoader: true
            }).catch (console.error);
        }

        function updatePaletteVisuals(qid, isAnswered, isReviewed) {
            const btn = document.getElementById(`palette-btn-${qid}`);
            if (!btn) return;
            btn.className = 'palette-btn'; // Reset
            if (qid === allQuestionIds[currentIdx]) btn.classList.add('current');
            if (isReviewed && isAnswered) btn.classList.add('review-answered');
            else if (isReviewed) btn.classList.add('review');
            else if (isAnswered) btn.classList.add('answered');
        }

        // --- NAVIGATION ---
        function clearCurrentResponse() {
            const qid = allQuestionIds[currentIdx];
            document.querySelectorAll(`input[name="question_${qid}"]`).forEach(r => {
                r.checked = false;
                r.closest('.option-wrapper').classList.remove('border-primary', 'bg-light');
            });
            const textInput = document.querySelector(`textarea[data-qid="${qid}"]`);
            if (textInput) {
                textInput.value = '';
                const badge = document.getElementById(`wc-${qid}`);
                if (badge) badge.innerText = "0 Words";
            }
            saveData(qid);
        }

        function showQuestionBlock(index) {
            if (index < 0 || index >= allQuestionIds.length) return;
            document.querySelectorAll('.question-block').forEach(el => el.classList.remove('active'));

            const qid = allQuestionIds[index];
            document.getElementById(`q-block-${qid}`).classList.add('active');
            currentIdx = index;

            // Update UI
            document.getElementById('btn-prev').disabled = (index === 0);
            const nextBtn = document.getElementById('btn-next');
            if (index === allQuestionIds.length - 1) {
                nextBtn.innerHTML = 'Submit <i class="bi bi-check-lg"></i>';
                nextBtn.className = "btn btn-success px-4";
            } else {
                nextBtn.innerHTML = 'Next <i class="bi bi-chevron-right"></i>';
                nextBtn.className = "btn btn-primary px-4";
            }

            // Palette
            document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('current'));
            const pBtn = document.getElementById(`palette-btn-${qid}`);
            if (pBtn) pBtn.classList.add('current');

            // Accordion
            const block = document.getElementById(`q-block-${qid}`);
            const sectionId = block.dataset.sectionId;
            const collapseEl = document.getElementById(`section-collapse-${sectionId}`);
            if (collapseEl && !collapseEl.classList.contains('show')) {
                new bootstrap.Collapse(collapseEl, { toggle: true });
            }

            // Review Toggle
            const hiddenInput = document.getElementById(`review_${qid}`);
            document.getElementById('current-review-chk').checked = hiddenInput ? hiddenInput.checked : false;
        }

        function navigate(direction) {
            if (direction === 1 && currentIdx === allQuestionIds.length - 1) {
                confirmSubmit();
                return;
            }
            showQuestionBlock(currentIdx + direction);
        }

        function jumpToQuestion(qid) {
            const idx = allQuestionIds.indexOf(qid);
            if (idx !== -1) showQuestionBlock(idx);
        }

        // --- SUBMISSION ---
        function confirmSubmit() {
            let answered = 0, review = 0, unanswered = 0;
            allQuestionIds.forEach(qid => {
                const hiddenInput = document.getElementById(`review_${qid}`);
                const isReviewed = hiddenInput ? hiddenInput.checked : false;
                const radio = document.querySelector(`input[name="question_${qid}"]:checked`);
                const text = document.querySelector(`textarea[data-qid="${qid}"]`);
                const hasText = text && text.value.trim().length > 0;

                if (radio || hasText) answered++; else unanswered++;
                if (isReviewed) review++;
            });

            document.getElementById('summary-answered').innerText = answered;
            document.getElementById('summary-review').innerText = review;
            document.getElementById('summary-unanswered').innerText = unanswered;
            const reviewWarn = document.getElementById('review-warning');
            if (review > 0) reviewWarn.classList.remove('d-none'); else reviewWarn.classList.add('d-none');
            submitModal.show();
        }

        // FIXED: PREVENT DOUBLE SUBMIT AND STOP TIMER
        let isSubmitting = false;
        function finalSubmit() {
            if (isSubmitting) return; // Prevent double trigger
            isSubmitting = true;

            // Stop the timer loop immediately
            if (window.examTimer) clearInterval(window.examTimer);

            // 1. Manually show loader because .submit() ignores event listeners
            if (window.showLoader) window.showLoader();
            // 2. Submit form
            document.getElementById('submit-form').submit();
        }

        // --- REPORTING LOGIC UPDATED ---
        window.reportQuestion = function (qid) {
            if (reportModal) {
                document.getElementById('report-qid').value = qid;
                document.getElementById('report-reason').value = '';
                reportModal.show();
            }
        };

        window.submitReport = function () {
            const qid = document.getElementById('report-qid').value;
            const reason = document.getElementById('report-reason').value;

            if (!reason.trim()) {
                alert("Please provide a reason."); // Validation
                return;
            }

            fetch("{% url 'report_question' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify({ question_id: qid, reason: reason }),
                skipLoader: true
            })
                .then(response => {
                    if (response.ok) {
                        reportModal.hide(); // Hide input modal
                        window.reportSuccessModal.show(); // Show nice success modal
                    } else {
                        alert("Failed to send report. Please try again.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Network error.");
                });
        };

        window.resumeAfterReport = function () {
            window.reportSuccessModal.hide();
            enableFullScreen(); // Triggers browser full-screen request via user gesture
        };

        // --- TIMER & FULLSCREEN ---
        function enableFullScreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen().then(() => {
                document.getElementById('fullscreen-overlay').style.display = 'none'; isFullScreen = true;
            }).catch(() => { document.getElementById('fullscreen-overlay').style.display = 'none'; });
            else document.getElementById('fullscreen-overlay').style.display = 'none';
        }

        let timeRemaining = {{ remaining_seconds }};
        const timerDisplay = document.querySelector('#timer span');
        const timerBox = document.getElementById('timer');
        let warningShown = false;

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        timerDisplay.innerText = formatTime(timeRemaining);

        // FIXED: ASSIGNED INTERVAL TO VARIABLE SO WE CAN STOP IT
        window.examTimer = setInterval(() => {
            if (!isFullScreen && timeRemaining > 0) return;
            timeRemaining--;

            // --- NEW: 2-Minute Warning Logic ---
            if (timeRemaining <= 120 && timeRemaining > 0 && !warningShown) {
                warningShown = true;
                if (window.timeWarningModal) window.timeWarningModal.show();
                timerBox.classList.remove('text-secondary');
                timerBox.style.backgroundColor = '#ffebee';
                timerBox.style.borderColor = '#dc3545';
                timerBox.style.color = '#dc3545';
                timerBox.classList.add('beat-animation');
            }
            // -----------------------------------

            if (timeRemaining <= 0) {
                timeRemaining = 0;
                clearInterval(window.examTimer); // STOP THE LOOP
                finalSubmit();
            }
            timerDisplay.innerText = formatTime(timeRemaining);
        }, 1000);

        function updateSystemTime() {
            document.getElementById('system-time').innerText = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }
        setInterval(updateSystemTime, 1000); updateSystemTime();

        // --- DESMOS CALCULATOR LOGIC ---
        function toggleDesmosCalculator() {
            const modal = document.getElementById('desmos-calculator-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                // Lazy init Desmos only once
                if (!window._desmosLoaded) {
                    setTimeout(function () {
                        var elt = document.getElementById('calculator');
                        window.desmosCalc = Desmos.GraphingCalculator(elt, { keypad: true });
                        window._desmosLoaded = true;
                    }, 100);
                }
            }
        }
        // Add keyboard shortcut (Ctrl+Alt+C) to open/close Desmos
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.altKey && e.key.toLowerCase() === 'c') {
                e.preventDefault();
                toggleDesmosCalculator();
            }
        });
        // Also close Desmos on overlay click (except box)
        document.getElementById('desmos-calculator-modal').addEventListener('click', function (e) {
            if (e.target === this) toggleDesmosCalculator();
        });

        // --- BATTERY STATUS ---
        if ('getBattery' in navigator) {
            navigator.getBattery().then(function (battery) {
                function updateBatteryInfo() {
                    const level = Math.round(battery.level * 100);
                    document.getElementById('battery-level').innerText = level + '%';
                    const icon = document.getElementById('battery-icon');
                    if (icon) {
                        if (level > 80) icon.className = 'bi bi-battery-full';
                        else if (level > 60) icon.className = 'bi bi-battery-three-quarters';
                        else if (level > 40) icon.className = 'bi bi-battery-half';
                        else if (level > 20) icon.className = 'bi bi-battery';
                        else icon.className = 'bi bi-battery';
                    }
                }
                updateBatteryInfo();
                battery.addEventListener('levelchange', updateBatteryInfo);
            });
        } else {
            document.getElementById('battery-level').innerText = 'N/A';
        }

        // ==========================================
        // 3. INITIALIZATION (DOMContentLoaded)
        // ==========================================
        document.addEventListener("DOMContentLoaded", function () {
            submitModal = new bootstrap.Modal(document.getElementById('submitSummaryModal'));
            reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            window.reportSuccessModal = new bootstrap.Modal(document.getElementById('reportSuccessModal'));

            // --- NEW: Time Warning Modal Init ---
            window.timeWarningModal = new bootstrap.Modal(document.getElementById('timeWarningModal'));

            // 1. Restore Answers
            for (const [qid, data] of Object.entries(savedAnswers)) {
                // Radio
                if (data.selected_option_id) {
                    const radio = document.getElementById(`opt_${data.selected_option_id}`);
                    if (radio) {
                        radio.checked = true;
                        radio.closest('.option-wrapper').classList.add('border-primary', 'bg-light');
                    }
                }
                // Text
                if (data.text_answer) {
                    const textArea = document.querySelector(`textarea[data-qid="${qid}"]`);
                    if (textArea) {
                        textArea.value = data.text_answer;
                        textArea.dispatchEvent(new Event('input'));
                    }
                }
                // Review
                const hiddenChk = document.getElementById(`review_${qid}`);
                if (hiddenChk && data.is_marked_for_review) hiddenChk.checked = true;

                // Visuals
                const hasAnswer = !!data.selected_option_id || (data.text_answer && data.text_answer.trim() !== '');
                updatePaletteVisuals(qid, hasAnswer, data.is_marked_for_review);
            }

            // 2. Attach Listeners
            document.querySelectorAll('.answer-input').forEach(input => {
                input.addEventListener('change', function () {
                    const qid = this.dataset.qid;
                    document.querySelectorAll(`input[name="question_${qid}"]`).forEach(el => {
                        el.closest('.option-wrapper').classList.remove('border-primary', 'bg-light');
                    });
                    this.closest('.option-wrapper').classList.add('border-primary', 'bg-light');
                    saveData(qid);
                });
            });

            document.querySelectorAll('.option-wrapper').forEach(wrapper => {
                wrapper.addEventListener('click', function (e) {
                    if (e.target !== this.querySelector('input') && e.target.tagName !== 'LABEL') {
                        const input = this.querySelector('input');
                        if (!input.checked) {
                            input.checked = true;
                            input.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });

            document.querySelectorAll('.answer-text-input').forEach(input => {
                if (input.dataset.type === 'ESSAY') {
                    const badge = document.getElementById(`wc-${input.dataset.qid}`);
                    badge.classList.remove('d-none');
                    input.addEventListener('input', function () {
                        const val = this.value.trim();
                        const words = val === '' ? 0 : val.split(/\s+/).length;
                        badge.innerText = `${words} Words`;
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => saveData(this.dataset.qid), 1000);
                    });
                } else {
                    input.addEventListener('blur', function () { saveData(this.dataset.qid); });
                }
            });

            document.getElementById('current-review-chk').addEventListener('change', function () {
                const qid = allQuestionIds[currentIdx];
                document.getElementById(`review_${qid}`).checked = this.checked;
                saveData(qid);
            });

            // 3. Init Draggable Calculator
            const dragElement = document.getElementById("exam-calculator");
            const dragHeader = document.getElementById("calc-header");
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            dragHeader.onmousedown = function (e) {
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = function () { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = function (e) {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                    pos3 = e.clientX; pos4 = e.clientY;
                    dragElement.style.top = (dragElement.offsetTop - pos2) + "px";
                    dragElement.style.left = (dragElement.offsetLeft - pos1) + "px";
                };
            };

            // 4. Smart Resume (Jump to first unanswered)
            let jumpIdx = 0;
            for (let i = 0; i < allQuestionIds.length; i++) {
                if (!savedAnswers[allQuestionIds[i]]) { jumpIdx = i; break; }
            }
            showQuestionBlock(jumpIdx);
        });

        // ==========================================
        // 5. MOBILE SIDEBAR TOGGLE
        // ==========================================
        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        };

        window.closeSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        };

        // Close sidebar when clicking on a question (mobile only)
        document.querySelectorAll('.palette-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                if (window.innerWidth < 992) {
                    closeSidebar();
                }
            });
        });
    </script>
</body>

</html>