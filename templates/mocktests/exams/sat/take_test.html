<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Exam - {{ test.item.title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']], displayMath: [['$$', '$$']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { background-color: #f4f6f8; height: 100vh; overflow: hidden; user-select: none; }
        /* Exam Header */
        .exam-header { height: 60px; background: white; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 20; }
        .timer-box { font-family: monospace; font-size: 1.2rem; font-weight: bold; }
        
        /* Layout */
        .exam-container { height: calc(100vh - 60px); display: flex; }
        .sidebar { width: 300px; background: white; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; }
        .question-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .question-scroll { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        
        /* Palette */
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; }
        .palette-btn { height: 40px; border: 1px solid #dee2e6; background: #f8f9fa; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; font-weight: 600; }
        .palette-btn.current { border-color: #0d6efd; box-shadow: 0 0 0 2px #0d6efd; }
        .palette-btn.answered { background: #198754; color: white; border-color: #198754; }
        .palette-btn.review { background: #6610f2; color: white; }

        /* Question Blocks */
        .question-block { display: none; }
        .question-block.active { display: block; }
        .option-wrapper:hover { background-color: #f8f9fa; border-color: #0d6efd !important; cursor: pointer; }
        
        /* Nav Footer */
        .nav-footer { height: 70px; background: white; border-top: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="exam-header">
        <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-mortarboard-fill me-2"></i>Digital SAT</h6>
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-dark" onclick="toggleCalculator()"><i class="bi bi-calculator me-1"></i> Calc</button>
            <div class="timer-box text-danger" id="timer">--:--</div>
            <button class="btn btn-sm btn-dark px-3 fw-bold" onclick="document.getElementById('submit-form').submit()">Finish</button>
        </div>
    </div>

    <div class="exam-container">
        <div class="question-area">
            <div class="question-scroll" id="q-container">
                {% for section in sections %}
                    {% for question in section.questions.all %}
                    <div class="question-block" id="q-block-{{ question.id }}" data-qid="{{ question.id }}">
                        
                        <div class="card border-0 shadow-sm p-4" style="max-width: 800px; margin: 0 auto;">
                            <div class="d-flex justify-content-between mb-4 border-bottom pb-3">
                                <span class="fw-bold text-uppercase text-muted">{{ section.title }}</span>
                                <span class="badge bg-light text-dark border">Question {{ forloop.counter }}</span>
                            </div>

                            <div class="fs-5 mb-4" style="line-height: 1.6;">
                                {{ question.question_text|safe|linebreaks }}
                            </div>

                            {% if question.question_type == 'MCQ' %}
                                {% for option in question.options.all %}
                                <div class="form-check mb-3 p-3 border rounded option-wrapper">
                                    <input class="form-check-input answer-input" type="radio" 
                                           name="q_{{ question.id }}" 
                                           id="opt_{{ option.id }}" 
                                           value="{{ option.id }}"
                                           onchange="saveData('{{ question.id }}')">
                                    <label class="form-check-label w-100" for="opt_{{ option.id }}">
                                        {{ option.option_text }}
                                    </label>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="mb-3">
                                    <label class="form-label text-muted small fw-bold">YOUR ANSWER</label>
                                    <input type="text" class="form-control form-control-lg text-answer-input" 
                                           data-qid="{{ question.id }}"
                                           placeholder="Enter value (e.g., 4.5)"
                                           onblur="saveData('{{ question.id }}')">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% endfor %}
            </div>

            <div class="nav-footer">
                <button class="btn btn-outline-secondary" onclick="move(-1)">Previous</button>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mark-review" onchange="toggleReview()">
                    <label class="form-check-label fw-bold small">Mark for Review</label>
                </div>
                <button class="btn btn-primary px-4" onclick="move(1)">Next</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="p-3 bg-light border-bottom fw-bold">Question Palette</div>
            <div class="flex-grow-1 overflow-auto">
                {% for section in sections %}
                <div class="p-2 bg-secondary bg-opacity-10 small fw-bold text-uppercase">{{ section.title }}</div>
                <div class="palette-grid">
                    {% for q in section.questions.all %}
                    <div class="palette-btn" id="pal-{{ q.id }}" onclick="jumpTo('{{ q.id }}')">{{ forloop.counter }}</div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <form id="submit-form" method="post" action="{% url 'submit_test' attempt.id %}">{% csrf_token %}</form>

    <div id="calculator" class="card shadow border-0" style="position: fixed; bottom: 80px; left: 20px; width: 250px; display: none; background: #343a40;">
        <div class="card-header bg-dark text-white d-flex justify-content-between py-2">
            <small>Calculator</small><button type="button" class="btn-close btn-close-white small" onclick="toggleCalculator()"></button>
        </div>
        <div class="p-2">
            <input id="calc-disp" class="form-control text-end mb-2 fw-bold" value="0" readonly>
            <div class="row g-1">
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="cInput('7')">7</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="cInput('8')">8</button></div>
                <div class="col-3"><button class="btn btn-secondary w-100 btn-sm" onclick="cInput('9')">9</button></div>
                <div class="col-3"><button class="btn btn-warning w-100 btn-sm" onclick="cSolve('/')">/</button></div>
                <div class="col-12"><button class="btn btn-primary w-100 btn-sm mt-1" onclick="cEval()">=</button></div>
                <div class="col-12"><button class="btn btn-danger w-100 btn-sm mt-1" onclick="document.getElementById('calc-disp').value='0'">Clear</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP ---
        const savedData = {{ answers_json|safe }};
        const questions = document.querySelectorAll('.question-block');
        const qIds = Array.from(questions).map(el => el.dataset.qid);
        let currIdx = 0;
        
        // --- 2. RESTORE STATE ---
        window.onload = function() {
            // Restore Answers
            for(const [qid, data] of Object.entries(savedData)) {
                if(data.selected_option_id) {
                    const r = document.querySelector(`input[name="q_${qid}"][value="${data.selected_option_id}"]`);
                    if(r) r.checked = true;
                }
                if(data.text_answer) {
                    const t = document.querySelector(`input[data-qid="${qid}"]`);
                    if(t) t.value = data.text_answer;
                }
                updatePalette(qid, true, data.is_marked_for_review);
            }
            showQ(0);
        };

        // --- 3. NAVIGATION ---
        function showQ(idx) {
            questions.forEach(el => el.classList.remove('active'));
            questions[idx].classList.add('active');
            currIdx = idx;
            
            // Highlight Palette
            document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('current'));
            document.getElementById(`pal-${qIds[idx]}`).classList.add('current');
            
            // Sync Review Checkbox
            // (Ideally fetch from savedData or DOM state)
        }
        function move(dir) {
            const next = currIdx + dir;
            if(next >= 0 && next < questions.length) showQ(next);
        }
        function jumpTo(qid) {
            const idx = qIds.indexOf(qid);
            if(idx !== -1) showQ(idx);
        }

        // --- 4. SAVING ---
        function saveData(qid) {
            const radio = document.querySelector(`input[name="q_${qid}"]:checked`);
            const text = document.querySelector(`input[data-qid="${qid}"]`);
            const optId = radio ? radio.value : null;
            const txtVal = text ? text.value : null;
            const isReview = document.getElementById('mark-review').checked; // Simplified
            
            updatePalette(qid, !!(optId || txtVal), isReview);

            fetch("{% url 'save_answer' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ attempt_id: {{ attempt.id }}, question_id: qid, option_id: optId, text_input: txtVal, is_reviewed: isReview })
            });
        }

        function updatePalette(qid, answered, review) {
            const btn = document.getElementById(`pal-${qid}`);
            btn.className = 'palette-btn'; // reset
            if(review) btn.classList.add('review');
            else if(answered) btn.classList.add('answered');
            if(qid === qIds[currIdx]) btn.classList.add('current');
        }

        // --- 5. EXTRAS ---
        function toggleCalculator() {
            const c = document.getElementById('calculator');
            c.style.display = c.style.display === 'none' ? 'block' : 'none';
        }
        function cInput(v) { document.getElementById('calc-disp').value += v; }
        function cEval() { 
            try { document.getElementById('calc-disp').value = eval(document.getElementById('calc-disp').value); } 
            catch { document.getElementById('calc-disp').value = 'Err'; }
        }

        // Timer
        let t = {{ remaining_seconds }};
        setInterval(() => {
            if(t<=0) document.getElementById('submit-form').submit();
            t--;
            const m = Math.floor(t/60).toString().padStart(2,0);
            const s = (t%60).toString().padStart(2,0);
            document.getElementById('timer').innerText = `${Math.floor(t/3600).toString().padStart(2,0)}:${m}:${s}`;
        }, 1000);
    </script>
</body>
</html>