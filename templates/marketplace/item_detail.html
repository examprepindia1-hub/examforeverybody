{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load currency_tags %}
{% block title %}{{ item.title }} - ExamForEverybody{% endblock %}
{% block meta_description %}{{ item.description|truncatewords:25 }}{% endblock %}

{% block og_title %}{{ item.title }}{% endblock %}
{% block og_description %}{{ item.description|truncatewords:30 }}{% endblock %}
{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{{ item.thumbnail_image.url }}{% endblock %}

{% block twitter_title %}{{ item.title }}{% endblock %}
{% block twitter_description %}{{ item.description|truncatewords:30 }}{% endblock %}
{% block twitter_image %}{{ request.scheme }}://{{ request.get_host }}{{ item.thumbnail_image.url }}{% endblock %}
{% block content %}

<script type="application/ld+json">
    {
      "@context": "https://schema.org/", 
      "@type": "Product", 
      "name": "{{ item.title|escapejs }}",
      "image": "{{ request.scheme }}://{{ request.get_host }}{% if item.thumbnail_image %}{{ item.thumbnail_image.url }}{% else %}/static/images/logo.svg{% endif %}",
      "description": "{{ item.description|striptags|truncatewords:50|escapejs }}",
      "sku": "{{ item.id }}",
      "offers": {
        "@type": "Offer",
        "url": "{{ request.build_absolute_uri }}",
        "priceCurrency": "INR",
        "price": "{{ item.price }}",
        "availability": "{% if item.is_active %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
      }
      {% if item.avg_rating %}
      ,
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ item.avg_rating }}",
        "reviewCount": "{{ item.total_reviews }}"
      }
      {% endif %}
    }
    </script>

{% if user.is_authenticated and not is_enrolled %}
    
    {% if latest_order_status == 'PENDING' %}
    <div class="alert alert-warning border-0 rounded-0 mb-0 text-center py-3" role="alert">
        <div class="container">
            <i class="bi bi-hourglass-split fs-4 align-middle me-2"></i>
            <span class="fw-bold">{% trans "Payment Processing..." %}</span>
            <span class="ms-2">
                {% trans "We have received your order request but payment is still confirming. Please wait a moment and" %} 
                <a href="." class="fw-bold text-decoration-underline text-dark">{% trans "refresh this page" %}</a>.
                If the status does not update, please contact support.
            </span>
        </div>
    </div>
    {% endif %}

    {% if latest_order_status == 'FAILED' %}
    <div class="alert alert-danger border-0 rounded-0 mb-0 text-center py-3" role="alert">
        <div class="container">
            <i class="bi bi-exclamation-circle-fill fs-4 align-middle me-2"></i>
            <span class="fw-bold">{% trans "Payment Failed" %}</span>
            <span class="ms-2">
                {% trans "Your last transaction was not successful. Please try purchasing again below." %}
            </span>
        </div>
    </div>
    {% endif %}

{% endif %}

<div style="background-color: var(--brand-dark); color: white;" class="py-5 mb-4">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="fw-bold text-light">{{ item.title }}</h1>
                 <p class="lead mb-3">{{ item.description|truncatewords:30 }}</p>
                 <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-warning text-dark me-2">
                        {% if item.item_type == 'MOCK_TEST' %}
                            {% trans "Mock Test" %}
                        {% elif item.item_type == 'WORKSHOP' %}
                            {% trans "Live Workshop" %}
                        {% endif %}
                    </span>
                     {% if item.categories.first %}
                        <span class="badge border border-light text-light">{{ item.categories.first.display_name }}</span>
                     {% endif %}
                 </div>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <div class="row">
        
        <div class="col-lg-8 order-2 order-lg-1">
             
             <h3 class="mb-3 fw-bold" style="color: var(--brand-dark);">{% trans "About this" %} {{ item.get_item_type_display }}</h3>
             <div class="mb-5">
                 {{ item.description|linebreaks }}
             </div>

             {% if item.item_type == 'MOCK_TEST' and item.mock_test_details %}
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h4 class="fw-bold mb-3">{% trans "Test Details" %}</h4>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-bar-chart-fill text-primary me-2"></i> <strong>{% trans "Level:" %}</strong> {{ item.mock_test_details.get_level_display }}</li>
                            <li class="mb-2"><i class="bi bi-clock-fill text-primary me-2"></i> <strong>{% trans "Duration:" %}</strong> {{ item.mock_test_details.duration_minutes }} {% trans "minutes" %}</li>
                        </ul>
                    </div>
                </div>

             {% elif item.item_type == 'WORKSHOP' and item.workshop_details %}
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h4 class="fw-bold mb-3">{% trans "Workshop Details" %}</h4>
                         <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-person-video3 text-primary me-2"></i> <strong>{% trans "Instructor:" %}</strong> {{ item.workshop_details.instructor.get_full_name }}</li>
                            <li class="mb-2"><i class="bi bi-hourglass-split text-primary me-2"></i> <strong>{% trans "Total Duration:" %}</strong> {{ item.workshop_details.total_duration_hours }} {% trans "hours" %}</li>
                        </ul>
                        <h5 class="mt-4 fw-bold">{% trans "Agenda / Description" %}</h5>
                        <p>{{ item.workshop_details.description_long|linebreaks }}</p>
                    </div>
                </div>
             {% endif %}

            <hr class="my-5">
            <h3 class="mb-4 fw-bold" style="color: var(--brand-dark);">
                 {% trans "Student Reviews" %}
            </h3>

            <div class="d-flex align-items-center mb-4">
                 <h1 class="fw-bold mb-0 me-3" style="color: var(--brand-dark);">
                     {{ avg_rating|default:"0.0"|floatformat:1 }}
                 </h1>
                 <div>
                     <div class="star-rating-static mb-1">
                        {% with rating_int=avg_rating|default:0|floatformat:0|add:0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating_int %}
                                    <i class="bi bi-star-fill"></i>
                                {% else %}
                                    <i class="bi bi-star"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                     </div>
                     <p class="text-muted small mb-0">
                         {{ review_count }} {% trans "ratings" %}
                     </p>
                 </div>
            </div>

            <div class="reviews-list">
                 {% for review in reviews %}
                 <div class="review-card">
                     <div class="d-flex mb-3">
                         <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 review-avatar">
                             {{ review.user.email|first|upper }}
                         </div>
                         <div>
                             <h6 class="fw-bold mb-1">
                                 {% if review.user.get_full_name %}
                                     {{ review.user.get_full_name }}
                                 {% else %}
                                     {{ review.user.email|truncatechars:10 }}
                                 {% endif %}
                             </h6>
                             <div class="d-flex align-items-center">
                                 <div class="star-rating-static me-2 small">
                                     {% for i in "12345" %}
                                         {% if forloop.counter <= review.rating %}
                                             <i class="bi bi-star-fill"></i>
                                         {% else %}
                                             <i class="bi bi-star"></i>
                                         {% endif %}
                                     {% endfor %}
                                 </div>
                                 <span class="review-date">
                                     {{ review.created|date:"M d, Y" }}
                                 </span>
                             </div>
                         </div>
                     </div>
                     <p class="mb-0 text-secondary">{{ review.text|linebreaksbr }}</p>
                 </div>
                 {% empty %}
                 <p class="text-muted py-3">
                     {% trans "No reviews yet. Be the first to review this item!" %}
                 </p>
                 {% endfor %}
            </div>

        </div>

        <div class="col-lg-4 order-1 order-lg-2 mb-4 position-relative">
            <div class="card shadow-sm sticky-lg-top hero-card-floating" style="top: 2rem; z-index: 100;">
                
                {% if item.thumbnail_image %}
                    <img src="{{ item.thumbnail_image.url }}" class="card-img-top" alt="{{ item.title }}" style="height: 200px; object-fit: cover;">
                {% else %}
                    <div class="bg-secondary" style="height: 200px;"></div>
                {% endif %}
                
                <div class="card-body p-4">
                    
                    {% if is_enrolled %}
                        <div class="text-center mb-4">
                            <span class="badge bg-success-subtle text-success border border-success mb-3 px-3 py-2 rounded-pill">
                                <i class="bi bi-check-circle-fill me-1"></i> {% trans "Enrolled" %}
                            </span>
                            <h3 class="fw-bold text-success">{% trans "You own this." %}</h3>
                            <p class="text-muted small">{% trans "Ready to continue your learning?" %}</p>
                        </div>

                        <div class="d-grid">
                            {% if item.item_type == 'MOCK_TEST' %}
    <a href="{% url 'start_test' item.slug %}" class="btn btn-success btn-lg w-100 shadow-sm">
        <i class="bi bi-play-circle-fill me-2"></i> {% trans "Start Test" %}
    </a>
{% elif item.item_type == 'WORKSHOP' %}
    <a href="#" class="btn btn-primary btn-lg w-100 shadow-sm">
        <i class="bi bi-camera-video-fill me-2"></i> {% trans "Join Session" %}
    </a>
{% endif %}
                        </div>

                    {% else %}
                        <div class="mb-4">
                            {% if PAYMENTS_ACTIVE %}
                                {% if exam.price > 0 %}
                                        <h2 class="fw-bold text-primary">{% show_price item %}</h2>
                                    {% endif %}
                                
                            {% else %}
                                <h2 class="fw-bold text-success">
                                    FREE
                                    <small class="text-muted text-decoration-line-through fs-6 ms-2">{% show_price item %}</small>
                                </h2>
                                <span class="badge bg-warning text-dark mb-2">Beta Access</span>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid">
                            {% if user.is_authenticated %}
                                <form action="{% url 'initiate_purchase' item.slug %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary-ud btn-lg w-100">
                                        {% if exam.price > 0 %}
                                            {% trans "Buy Now" %}
                                        {% else %}
                                            {% trans "Enroll for Free" %}
                                        {% endif %}
                                    </button>
                                </form>
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary btn-lg">
                                    {% trans "Log in to Enroll" %}
                                </a>
                            {% endif %}
                        </div>                        
                    {% endif %}
                    <hr>
                    <h6 class="fw-bold">{% trans "This includes:" %}</h6>
                    <ul class="list-unstyled small text-muted">
                        <li class="mb-2"><i class="bi bi-check-lg text-success me-2"></i> {% trans "Full lifetime access" %}</li>
                        {% if item.item_type == 'MOCK_TEST' %}
                             <li><i class="bi bi-check-lg text-success me-2"></i> {% trans "Detailed performance analytics" %}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

    </div> </div> {% endblock %}